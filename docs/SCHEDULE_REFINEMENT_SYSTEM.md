# Competition Schedule Refinement System

## Overview

This system enables precise tracking of which underdog nations compete in which specific events on which dates. It replaces the broad "all events in a sport" approach with granular event-level mappings.

## Architecture

### Core Components

1. **EventUnderdogMapper** ([src/event_underdog_mapper.py](../src/event_underdog_mapper.py))
   - Manages Event → Date → Underdog Nations mappings
   - Loads underdog criteria and participating nations
   - Provides query methods for dates, nations, and disciplines
   
2. **WatchlistGenerator** ([src/watchlist_generator.py](../src/watchlist_generator.py))
   - Updated to use EventUnderdogMapper
   - Generates refined watchlists showing only events with underdogs
   - Supports both mapped (refined) and unmapped (legacy) modes

3. **populate_event_mappings.py** ([scripts/populate_event_mappings.py](../scripts/populate_event_mappings.py))
   - Helper script to add manual mappings
   - Pre-configured with Skeleton sport as example
   - Template for adding other sports

## Workflow

### Phase 1: Data Verification ✓
- [x] Fix participating nations count (85 nations)
- [x] Fix underdog count (56 nations)
- [x] Update website statistics

### Phase 2: Manual Event Mapping (Your Task)
For each sport, research and identify:
1. Which underdog nations have qualified athletes
2. Which specific events each underdog competes in
3. Which dates those events occur

**Resources:**
- Wikipedia qualification pages (e.g., "Skeleton at 2026 Winter Olympics – Qualification")
- Official IOC schedule: `data/schedules/ioc_schedule_authoritative.json`
- Participating nations list: `data/participating_nations_2026.json`

**Example (Skeleton - Already Completed):**
- Men's Skeleton: Denmark (1), Israel (1)
- Women's Skeleton: Brazil (1), Denmark (1), South Africa (1)
- Competition dates: Feb 12-15

### Phase 3: Add Mappings to Script
Edit `scripts/populate_event_mappings.py`:

```python
# Add mappings for your sport
mapper.add_event_mapping(
    discipline="Speed Skating",
    event="Women's 500m",
    date="2026-02-15",
    underdog_nations=["TPE", "DEN", "POR"],  # Chinese Taipei, Denmark, Portugal
    stage="Final"
)
```

### Phase 4: Generate Mappings
Run the population script:

```bash
python scripts/populate_event_mappings.py
```

This creates: `data/event_underdog_mappings.json`

### Phase 5: Generate Refined Watchlists
Use the mapping file to generate precise watchlists:

```python
from src.event_underdog_mapper import EventUnderdogMapper
from src.watchlist_generator import WatchlistGenerator

# Load mapper
mapper = EventUnderdogMapper()
mapper.load_mappings()  # Loads event_underdog_mappings.json

# Pass to watchlist generator
generator = WatchlistGenerator(..., event_mapper=mapper)

# Generate refined watchlist
watchlist = generator.generate_for_date("2026-02-13")
```

## File Structure

```
data/
├── event_underdog_mappings.json       # Generated by populate_event_mappings.py
├── participating_nations_2026.json    # Official 85 nations list
├── schedules/
│   └── ioc_schedule_authoritative.json  # Official IOC schedule
├── medals/
│   ├── all_time_medals.json
│   └── winter_medals.json
└── population/
    └── population.json

src/
├── event_underdog_mapper.py           # Core mapping system
└── watchlist_generator.py             # Updated to use mappings

scripts/
└── populate_event_mappings.py         # Helper to add mappings
```

## Data Format

### event_underdog_mappings.json

```json
{
  "metadata": {
    "total_events_with_underdogs": 150,
    "total_underdog_nations": 56,
    "underdog_nations": ["ALB", "AND", ...],
    "generated": "2026-01-25T10:30:00"
  },
  "event_mappings": {
    "Skeleton|Men's Skeleton|2026-02-12|Heat 1": {
      "discipline": "Skeleton",
      "event": "Men's Skeleton",
      "date": "2026-02-12",
      "stage": "Heat 1",
      "underdog_nations": ["DEN", "ISR"],
      "underdog_count": 2
    }
  },
  "discipline_summary": {
    "Skeleton": {
      "events": ["Men's Skeleton", "Women's Skeleton", "Mixed Team"],
      "dates": ["2026-02-12", "2026-02-13", "2026-02-14", "2026-02-15"],
      "underdogs": ["BRA", "DEN", "ISR", "RSA"],
      "event_count": 9
    }
  }
}
```

## Sport Processing Checklist

Track which sports have been fully mapped:

### Completed (5/16)
- [x] Skeleton (3 underdogs: BRA, DEN, ISR, RSA)
- [x] Ski Jumping (1 underdog: TUR)
- [x] Ski Mountaineering (1 underdog: AUS)
- [x] Speed Skating (4 underdogs: TPE, DEN, EST, POR)
- [x] Snowboard (2 underdogs: AUS, BRA)

### To Map (11/16)
- [ ] Alpine Skiing (57 underdogs)
- [ ] Biathlon
- [ ] Bobsleigh
- [ ] Cross-Country Skiing
- [ ] Curling
- [ ] Figure Skating
- [ ] Freestyle Skiing
- [ ] Ice Hockey
- [ ] Luge
- [ ] Nordic Combined
- [ ] Short Track Speed Skating

## Benefits

1. **Precision**: Only show events where underdogs actually compete
2. **Efficiency**: Viewers see exactly when to watch
3. **Scalability**: Easy to add new sports incrementally
4. **Maintainability**: Single source of truth for event mappings
5. **Flexibility**: Can query by date, nation, or discipline

## Next Steps

1. **Research qualification results** for remaining sports
2. **Add mappings** to populate_event_mappings.py
3. **Run script** to generate complete mapping file
4. **Update watchlist generation** to use refined mappings
5. **Verify accuracy** by checking sample dates

## Questions?

See [DISCIPLINE_SCHEDULE_GUIDE.md](../DISCIPLINE_SCHEDULE_GUIDE.md) for detailed sport-by-sport methodology.
